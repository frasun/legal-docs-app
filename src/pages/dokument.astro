---
import { getSession } from "../auth-astro/server";
import { getUserByEmail } from "../../db/auth";
import { createDocument, publishDraft } from "../../db/document";
import cryptr from "../utils/crypt";
import { getEntry } from "astro:content";

const session = await getSession(Astro.request);
const user = session ? await getUserByEmail(String(session.user?.email)) : null;
const userId = user ? user.id : null;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const id = formData.get("id");
  const draft = Boolean(formData.get("draft"));
  let answers = {},
    encrypted = [];

  if (Number(id)) {
    try {
      await publishDraft(id);

      return Astro.redirect(`/dokumenty/${id}/dokument`);
    } catch {
      Astro.redirect("/404");
    }
  } else {
    const template = await getEntry("documents", String(id));

    if (!template) {
      Astro.redirect("/404");
    } else {
      encrypted = template.data.encrypted;
    }
  }

  formData.forEach((value, key) => {
    if (!["id", "draft"].includes(key)) {
      if (encrypted.includes(key)) {
        answers[key] = cryptr.encrypt(String(value));
      } else {
        answers[key] = value;
      }
    }
  });

  if (session) {
    const docId = await createDoc(id, answers, draft, userId);

    if (docId) {
      return Astro.redirect(
        `${Astro.url.origin}/${
          draft ? `moje-dokumenty` : `dokumenty/${docId}/dokument`
        }`
      );
    } else {
      return Astro.redirect("/404");
    }
  } else {
    Astro.cookies.set(
      "document",
      { id, answers, draft },
      { maxAge: 6000, httpOnly: true }
    );
    return Astro.redirect("/zaloguj-sie?redirect=dokument");
  }
} else if (Astro.cookies.has("document")) {
  const { id, answers, draft } = Astro.cookies.get("document").json();
  const docId = await createDoc(id, answers, draft, userId);

  Astro.cookies.delete("document");

  if (docId) {
    return Astro.redirect(
      `${Astro.url.origin}/${
        draft ? `moje-dokumenty` : `dokumenty/${docId}/dokument`
      }`
    );
  } else {
    return Astro.redirect("/404");
  }
} else {
  return Astro.redirect("/404");
}

async function createDoc(id, answers, draft, userId) {
  const document = await createDocument(id, answers, userId, draft);
  const docId = document ? document.id : null;

  return docId;
}
---
