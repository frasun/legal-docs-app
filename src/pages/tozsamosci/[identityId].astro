---
import Layout from "../../layouts/App.astro";
import pageTitle from "@utils/pageTitle";
import DataInput from "@components/DataInput.astro";
import { entityEnum } from "@utils/constants";
import routes from "@utils/routes";
import { REDIRECT } from "@utils/urlParams";
import { getIdentity } from "@api/identities";
import { Identity } from "@type";
import { captureError } from "@utils/sentry";

const { identityId } = Astro.params as { identityId: string };

const PAGE_TITLE = "Edytuj tożsamość";
let type: Identity["type"],
  name: Identity["name"],
  pin: Identity["pin"],
  street: Identity["street"],
  apt: Identity["apt"],
  postalCode: Identity["postalCode"],
  city: Identity["city"],
  personName = "",
  personStreet = "",
  personApt: Identity["apt"] = "",
  personPostalCode = "",
  personCity = "",
  personPin = "",
  companyName = "",
  companyStreet = "",
  companyApt: Identity["apt"] = "",
  companyPostalCode = "",
  companyCity = "",
  companyPin = "";

try {
  ({ type, name, pin, street, apt, postalCode, city } = await getIdentity(
    identityId,
    `${Astro.request.headers.get("cookie")}`
  ));
} catch (e) {
  if (e instanceof Error) {
    if (e.cause === 404) {
      return Astro.redirect(routes.NOT_FOUND);
    }
  }

  captureError(e);
  return Astro.redirect(routes.NOT_FOUND);
}

switch (type) {
  case entityEnum[0]:
    personName = name;
    personPin = pin;
    personStreet = street;
    personApt = apt;
    personPostalCode = postalCode;
    personCity = city;
    break;
  case entityEnum[1]:
    companyName = name;
    companyPin = pin;
    companyStreet = street;
    companyApt = apt;
    companyPostalCode = postalCode;
    companyCity = city;
    break;
  default:
    return Astro.redirect(routes.NOT_FOUND);
}
---

<Layout title={pageTitle(PAGE_TITLE)}>
  <span slot="topbar-title">{PAGE_TITLE}</span>
  <identity-form data-identity-id={identityId}>
    <form method="POST">
      <header>
        <h3>Wypełnij formularz z danymi</h3>
      </header>
      <DataInput
        type={type}
        personName={personName}
        personStreet={personStreet}
        personApt={personApt}
        personPostalCode={personPostalCode}
        personCity={personCity}
        personPin={personPin}
        companyName={companyName}
        companyStreet={companyStreet}
        companyApt={companyApt}
        companyPostalCode={companyPostalCode}
        companyCity={companyCity}
        companyPin={companyPin}
      />
      <footer>
        <a href={`${Astro.url.origin}/tozsamosci`}>Anuluj</a>
        <button type="submit">Zapisz</button>
      </footer>
    </form>
  </identity-form>
</Layout>

<style>
  form {
    @apply w-full max-w-[780px] mx-auto;
    @apply flex flex-col justify-center min-h-full;
    @apply py-[var(--navbar-height)];
  }

  form header {
    @apply flex flex-col gap-15 mb-15;
  }

  form :global(fieldset) {
    @apply flex flex-col gap-20;
  }

  form footer {
    @apply flex justify-between items-center;
    @apply my-30;
  }

  form footer button[type="submit"],
  form footer a {
    @apply btn btn-big;
  }

  form footer a {
    @apply btn-alt;
  }

  form footer button[type="submit"] {
    @apply btn-default;
  }
</style>

<script>
  import "@wc/IdentityForm";
</script>
