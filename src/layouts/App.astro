---
import Layout from "./Layout.astro";
import AppMenu from "../components/AppMenu.astro";
import { getSession } from "../auth-astro/server";
import { Icon } from "astro-icon";
import SignedInMenu from "../components/SignedInMenu.astro";

const { title, backurl } = Astro.props;
const session = await getSession(Astro.request);

const redirectUrl = String(Astro.url).replace(Astro.url.origin, "").slice(1);
---

<Layout title={title}>
  <AppMenu session={session} />
  <main>
    <header>
      {
        backurl && (
          <a href={backurl} aria-label="Wstecz">
            <Icon name="arrow-back" width={16} height={16} />
          </a>
        )
      }
      <div>
        <h1>
          <slot name="topbar-title">title</slot>
        </h1>
        <slot name="topbar-after-title" />
      </div>
      <aside>
        <slot name="topbar-aside" />
        <nav>
          {
            session ? (
              <SignedInMenu email={session.user?.email} />
            ) : (
              <>
                <a
                  href={`${Astro.url.origin}/zaloz-konto?redirect=${redirectUrl}`}
                >
                  Załóż konto
                </a>
                <a
                  href={`${Astro.url.origin}/zaloguj-sie?redirect=${redirectUrl}`}
                >
                  Zaloguj się
                </a>
              </>
            )
          }
        </nav>
      </aside>
    </header>
    <slot name="content-header" />
    <section>
      <slot />
    </section>
  </main>
  <slot name="footer" />
</Layout>

<style is:inline>
  body {
    display: flex;
    height: 100vh;
  }
</style>
<style is:global>
  :root {
    --navbar-height: 62px;
  }
</style>

<style>
  main {
    @apply flex-grow;
    @apply overflow-auto;
    @apply px-30;
    @apply flex flex-col;
  }

  main > header {
    @apply flex items-center;
    @apply sticky top-0;
    @apply bg-gray;
    @apply gap-15;
    @apply z-10;
    @apply w-full;
    @apply min-h-[var(--navbar-height)];
  }

  main > header > div {
    @apply flex-grow flex gap-10 items-center;
  }

  main > header h1 {
    @apply font-sans font-bold not-italic text-dark65 tracking-tight;
    @apply text-xl;
  }

  main > header h1 :global(> span) {
    @apply flex items-center gap-5;
  }

  main > header > a {
    @apply btn btn-alt;
  }

  main > header > aside {
    @apply flex gap-30 items-center;
  }

  main > header > aside nav {
    @apply flex gap-15 items-center;
  }

  main > header > aside nav a {
    @apply btn btn-default;
  }

  main > header > aside nav button {
    @apply btn btn-alt;
  }

  main > section {
    @apply flex items-start justify-center flex-1 gap-30;
    @apply pb-[var(--navbar-height)];
  }
</style>
