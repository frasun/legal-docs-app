---
import Layout from "../layouts/Layout.astro";
import { getUserByEmail, activateUser } from "@db/auth";
import error from "@utils/errors";
import pageTitle from "@utils/pageTitle";
import AuthForm from "@components/AuthForm.astro";

const url = new URL(Astro.request.url);
const emailParam = url.searchParams.get("email");
const userEmail = emailParam ? decodeURIComponent(emailParam) : null;

if (!userEmail) {
  return Astro.redirect("/404");
}

const redirectParam = url.searchParams.get("redirect");
const docParam = url.searchParams.get("doc");
const draftParam = url.searchParams.get("draft");

const redirectUrl = redirectParam
  ? new URL(redirectParam, Astro.url.origin)
  : null;

if (redirectUrl) {
  if (docParam) {
    redirectUrl.searchParams.append("doc", docParam);
  }

  if (draftParam) {
    redirectUrl.searchParams.append("draft", draftParam);
  }
}

let errors = [];
let userPassword;

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const postedCode = formData.get("code");
  const user = await getUserByEmail(userEmail);

  if (user) {
    const { code, id, password } = user;
    if (code === postedCode) {
      await activateUser(id);

      userPassword = password;
    } else {
      errors.push(error.WRONG_VERIFICATION_CODE);
    }
  } else {
    return Astro.redirect("/404");
  }
}
---

<Layout title={pageTitle("Weryfikacja adresu e-mail")}>
  {
    userPassword ? (
      <auto-login
        email={userEmail}
        password={userPassword}
        redirect={redirectUrl}
      />
    ) : (
      <AuthForm hasBackLink={false}>
        <p slot="form-header">
          Podaj kod wysłany na adres e-mail <strong>{userEmail}</strong>
        </p>
        <input type="text" name="code" required />
        <button type="submit">Wyślij</button>
        {errors.length
          ? errors.map((error) => <p slot="after-submit">{error}</p>)
          : null}
      </AuthForm>
    )
  }
</Layout>

<script>
  import { signIn } from "auth-astro/client";

  class AutoLogin extends HTMLElement {
    redirect?: string;
    email?: string;
    password?: string;

    constructor() {
      super();

      this.redirect = this.getAttribute("redirect") || undefined;
      this.email = this.getAttribute("email") || undefined;
      this.password = this.getAttribute("password") || undefined;
    }

    async connectedCallback() {
      const response = await signIn("credentials", {
        redirect: false,
        email: this.email,
        password: this.password,
        callbackUrl: `${
          this.redirect
            ? this.redirect
            : `${document.location.origin}/moje-dokumenty`
        }`,
      });

      if (response) {
        document.location.href = "/zaloguj-sie";
      }
    }
  }
  customElements.define("auto-login", AutoLogin);
</script>
