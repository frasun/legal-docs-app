---
import Layout from "../../../layouts/App.astro";
import pageTitle from "@utils/pageTitle";
import formatNumber from "@utils/number";
import BlogPost from "@components/BlogPost.astro";
import BlogContent from "@components/BlogContent.astro";
import type { Document } from "@type";
import headers from "@utils/headers";

let title: Document["title"] = "",
  keywords: Document["keywords"],
  description: Document["description"],
  body: Document["body"],
  posts: Document["posts"] = null,
  price: Document["price"] = null,
  firstQuestionUrl: Document["firstQuestionUrl"] = "";

async function getDocument(documentId: string): Promise<Document> {
  const response = await fetch(
    `${Astro.url.origin}/api/documents/${documentId}`,
    {
      headers: {
        ...headers,
        cookie: Astro.request.headers.get("cookie") as string,
      },
    }
  );

  if (!response.ok) {
    throw new Error("", { cause: response.status });
  }

  return response.json();
}

try {
  const response = await getDocument(Astro.params.documentId as string);

  ({ title, keywords, description, body, posts, price, firstQuestionUrl } =
    response);
} catch (e) {
  if (e instanceof Error) {
    if (e.cause === 401) {
      return Astro.redirect(
        `/zaloguj-sie?redirect=${new URL(Astro.request.url).pathname}`
      );
    } else {
      return Astro.redirect("/404");
    }
  }
}
---

<Layout title={pageTitle(title)} keyword={keywords} description={description}>
  <span slot="topbar-title">{title}</span>
  <section>
    <header>
      <h1>{title}</h1>
      <span>
        <small>Cena za 1 dokument:</small>
        {price && <strong>{formatNumber(price)} zł</strong>}
      </span>
      <a href={`${Astro.url.origin}${firstQuestionUrl}`}>Stwórz dokument</a>
    </header>
    <hr />
    {
      body && (
        <article class="prose">
          <BlogContent content={body} />
        </article>
      )
    }
    {
      posts && (
        <>
          <hr />
          <aside>
            <h4>Powiązane artykuły</h4>
            <div>
              {posts.map(
                ({
                  title,
                  slug: { current: url },
                  publishedAt,
                  mainImage,
                  excerpt,
                }) => (
                  <BlogPost
                    title={title}
                    url={url}
                    publishedAt={publishedAt}
                    mainImage={mainImage}
                    excerpt={excerpt}
                    size="small"
                  />
                )
              )}
            </div>
          </aside>
        </>
      )
    }
    <footer>
      <a href={`${Astro.url.origin}${firstQuestionUrl}`}>Stwórz dokument</a>
    </footer>
  </section>
</Layout>

<style>
  section {
    @apply bg-white rounded-lg p-20 sm:p-40 my-20 flex flex-col gap-30 max-w-[1000px];
  }

  header {
    @apply flex items-center gap-15 lg:gap-30 flex-wrap;
  }

  header h1 {
    @apply flex-grow;
    @apply text-2xl;
    @apply w-full lg:w-auto;
  }

  header span {
    @apply flex flex-col lg:items-end flex-grow;
  }

  header span strong {
    @apply text-lg;
  }

  footer a,
  header a {
    @apply btn btn-default btn-big;
  }

  hr {
    @apply border-dark30;
  }

  footer {
    @apply p-20 flex justify-center;
  }

  footer a {
    @apply btn-big;
  }

  aside > div {
    @apply grid sm:grid-cols-2 lg:grid-cols-3 gap-20;
    @apply pt-10;
  }
</style>
