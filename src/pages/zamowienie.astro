---
import Stripe from "stripe";
import { nanoid } from "nanoid";
import { Icon } from "astro-icon";
import Layout from "../layouts/Layout.astro";
import pageTitle from "@utils/pageTitle";
import { getEntry } from "astro:content";
import { getSession } from "auth-astro/server";
import { SESSION_COOKIE } from "@utils/cookies";
import { createPaymentSession } from "@db/session";
import * as PARAMS from "@utils/urlParams";
import { getDocumentId } from "@db/document";

const SUMMARY = "podsumowanie";
const refererUrl = Astro.request.headers.get("referer");
const urlParams = new URL(Astro.request.url).searchParams;
const session = await getSession(Astro.request);
let documentId, documentName;

if (!refererUrl) {
  return Astro.redirect("/404");
}

documentId = urlParams.get(PARAMS.DOCUMENT);

if (!documentId) {
  const urlSegments = refererUrl.split("/");
  if (urlSegments[urlSegments.length - 1] !== SUMMARY) {
    return Astro.redirect("/404");
  }

  documentName = urlSegments[urlSegments.length - 2];

  if (Number(documentName) && session) {
    documentId = await getDocumentId(documentName, session.user?.id as string);
  } else {
    documentId = urlSegments[urlSegments.length - 2];
  }
}

if (!documentName || !documentId) {
  return Astro.redirect("/404");
}

const document = await getEntry("documents", documentId);

if (!document) {
  return Astro.redirect("/404");
}

const { priceId } = document.data;

const ssid = session
  ? session.user?.ssid
  : Astro.cookies.get(SESSION_COOKIE).value;

if (!ssid) {
  return Astro.redirect("/404");
}

const pid = nanoid();
await createPaymentSession(pid, ssid, documentName);

const stripe = new Stripe(import.meta.env.STRIPE_API_KEY, {
  apiVersion: import.meta.env.STRIPE_API_V,
});

const stripeSession = await stripe.checkout.sessions.create({
  line_items: [
    {
      price: priceId,
      quantity: 1,
    },
  ],
  mode: "payment",
  success_url: `${Astro.url.origin}/dokument?${PARAMS.PAYMENT}=${pid}&${PARAMS.DRAFT}=false`,
  cancel_url: Number(documentName)
    ? refererUrl
    : `${Astro.url.origin}/dokument?${PARAMS.PAYMENT}=${pid}&${PARAMS.DRAFT}=true`,
  customer_email: session ? (session.user?.email as string) : undefined,
});

if (stripeSession.url) {
  return Astro.redirect(stripeSession.url);
} else {
  return Astro.redirect("/404");
}
---

<Layout title={pageTitle("ZamÃ³wienie")}>
  <Icon name="loader" width={64} height={64} />
</Layout>

<style is:inline>
  body {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100vh;
    width: 100vw;
  }
</style>
