---
import Layout from "../../../layouts/App.astro";
import Answer from "@components/Answer.astro";
import { getSession } from "auth-astro/server";
import { Icon } from "astro-icon";
import ChangeNameButton from "@components/ChangeNameButton.astro";
import ChangeNameModal from "@components/ChangeNameModal.astro";
import Badge from "@components/Badge.astro";
import pageTitle from "@utils/pageTitle";
import Toast from "@components/Toast.astro";
import {
  DOCUMENT_NAME_CHANGED,
  DOCUMENT_NAME_PARAM,
  ERROR,
  ERROR_PARAM,
  ToastStatus,
} from "@utils/toasts";
import type { TemplateSummary } from "@type";
import { deleteSessionDocument } from "@db/session";
import { SESSION_COOKIE } from "@utils/cookies";
import PaymentModal from "@components/PaymentModal.astro";
import * as PARAMS from "@utils/urlParams";
import { UUID } from "mongodb";
import routes from "@utils/routes";
import { changeDocumentName } from "@api/documents";
import { getTemplateSummary } from "@api/templates";

const { documentId } = Astro.params as { documentId: string };
const session = await getSession(Astro.request);
const isUserDocument = UUID.isValid(documentId);

const ssid = session
  ? session.user?.ssid
  : Astro.cookies.get(SESSION_COOKIE).value;

if (!ssid) {
  return Astro.redirect(routes.NOT_FOUND);
}

if (!isUserDocument) {
  const refererUrl = Astro.request.headers.get("referer");

  if (!refererUrl || !refererUrl.includes(documentId)) {
    await deleteSessionDocument(ssid, documentId);
  }
}

let answers: TemplateSummary["answers"] = {},
  index: TemplateSummary["index"] = [],
  title: TemplateSummary["title"] = "",
  canGenerate: TemplateSummary["canGenerate"] = true,
  toast: string | null = null,
  toastStatus: ToastStatus = ToastStatus.default;

const urlParams = new URL(Astro.request.url).searchParams;

if (urlParams.has(DOCUMENT_NAME_PARAM)) {
  toast = DOCUMENT_NAME_CHANGED;
  toastStatus = ToastStatus.default;
}

if (urlParams.has(ERROR_PARAM)) {
  toast = ERROR;
  toastStatus = ToastStatus.error;
}

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const title = String(formData.get("title"));
  const docId = String(formData.get("template"));
  const redirectUrl = new URL(Astro.request.url);

  try {
    await changeDocumentName(
      `${Astro.request.headers.get("cookie")}`,
      docId,
      title
    );

    redirectUrl.searchParams.set(DOCUMENT_NAME_PARAM, "true");
  } catch {
    redirectUrl.searchParams.set(ERROR_PARAM, "true");
  } finally {
    return Astro.redirect(redirectUrl);
  }
}

const GENERATE = "Generuj dokument";

try {
  ({ title, answers, index, canGenerate } = await getTemplateSummary(
    `${Astro.request.headers.get("cookie")}`,
    documentId
  ));
} catch (e) {
  if (e instanceof Error) {
    if (e.cause === 403) {
      return Astro.redirect(
        `${routes.SIGN_IN}?${REDIRECT}=${Astro.url.pathname}`
      );
    }

    if (e.cause === 303) {
      return Astro.redirect(`${routes.DOCUMENTS}/${documentId}/dokument`);
    }

    return Astro.redirect(routes.NOT_FOUND);
  }
}
---

<Layout title={pageTitle(`Podsumowanie - ${title}`)}>
  <span slot="topbar-title"><span>{title}</span><Badge>Szkic</Badge></span>
  {
    isUserDocument && (
      <ChangeNameButton
        id={documentId}
        title={title}
        slot="topbar-after-title"
      />
    )
  }
  <section>
    <h1>Podsumowanie</h1>
    {
      index.map(({ title, questions }) => (
        <>
          <h5>{title}</h5>
          {questions.map(({ title, slug, answer, token, type }) => (
            <div>
              <div>
                <h6>{title}</h6>
                <Answer
                  template={answer}
                  data={answers}
                  token={token}
                  type={type}
                />
              </div>
              <a href={`${Astro.url.origin}/dokumenty/${documentId}/${slug}`}>
                Zmień
              </a>
            </div>
          ))}
        </>
      ))
    }
    <footer>
      {
        canGenerate ? (
          session ? (
            <a
              href={`${Astro.url.origin}${routes.DOCUMENTS}/${documentId}${routes.ORDER}`}
            >
              {GENERATE}
            </a>
          ) : (
            <show-modal data-modal="payment">
              <button>{GENERATE}</button>
            </show-modal>
          )
        ) : (
          <h4>Aby wygenerować dokument wypełnij wszystkie wymagane pola</h4>
        )
      }
      {
        !isUserDocument && (
          <a
            href={`${Astro.url.origin}${routes.DOCUMENT}?${PARAMS.DOCUMENT}=${documentId}&${PARAMS.DRAFT}=true`}
          >
            <Icon name="save" width={18} height={18} />
            Zapisz szkic
          </a>
        )
      }
    </footer>
  </section>
  <ChangeNameModal />
  <PaymentModal documentId={documentId} />
  {toast && <Toast info={toast} status={toastStatus} />}
</Layout>
<style>
  section {
    @apply max-w-[1000px] mx-auto w-full mt-20;
  }

  section h1 {
    @apply text-2xl;
  }

  section h5 {
    @apply mt-30 mb-10 font-sans font-bold text-sm tracking-normal text-dark55;
  }

  section > div {
    @apply bg-white my-10 py-15 px-20 rounded-lg;
    @apply flex items-start sm:items-center gap-10;
    @apply flex-col sm:flex-row;
  }

  section > div > div {
    @apply flex-grow;
  }

  section a {
    @apply btn btn-alt;
  }

  footer {
    @apply pt-50;
    @apply flex flex-col justify-center gap-20 items-center;
  }

  footer a {
    @apply btn btn-alt;
  }

  footer a:first-child,
  footer button,
  show-payment-modal button {
    @apply btn btn-default btn-big;
  }
</style>

<script>
  import "@wc/ShowModal";
</script>
